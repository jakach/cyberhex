<!DOCTYPE html>
<html>
<head>
    <title>lbuchs/WebAuthn Test</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>lbuchs/WebAuthn</h1>
    <div>
        <button type="button" onclick="createRegistration()">Register</button>
        <button type="button" onclick="checkRegistration()">Login</button>
    </div>

    <script>
        async function createRegistration() {
            try {
                if (!window.fetch || !navigator.credentials || !navigator.credentials.create) {
                    throw new Error('Browser not supported.');
                }

                let rep = await window.fetch('server.php?fn=getCreateArgs', { method: 'GET', cache: 'no-cache' });
                const createArgs = await rep.json();

                if (createArgs.success === false) {
                    throw new Error(createArgs.msg || 'Unknown error occurred');
                }

                const cred = await navigator.credentials.create(createArgs);

                const authenticatorAttestationResponse = {
                    transports: cred.response.getTransports ? cred.response.getTransports() : null,
                    clientDataJSON: cred.response.clientDataJSON ? arrayBufferToBase64(cred.response.clientDataJSON) : null,
                    attestationObject: cred.response.attestationObject ? arrayBufferToBase64(cred.response.attestationObject) : null
                };

                rep = await window.fetch('server.php?fn=processCreate', {
                    method: 'POST',
                    body: JSON.stringify(authenticatorAttestationResponse),
                    cache: 'no-cache'
                });
                const authenticatorAttestationServerResponse = await rep.json();

                if (authenticatorAttestationServerResponse.success) {
                    window.alert(authenticatorAttestationServerResponse.msg || 'Registration success');
                } else {
                    throw new Error(authenticatorAttestationServerResponse.msg);
                }

            } catch (err) {
                window.alert(err.message || 'Unknown error occurred');
            }
        }

        async function checkRegistration() {
            try {
                if (!window.fetch || !navigator.credentials || !navigator.credentials.create) {
                    throw new Error('Browser not supported.');
                }

                let rep = await window.fetch('server.php?fn=getGetArgs', { method: 'GET', cache: 'no-cache' });
                const getArgs = await rep.json();

                if (getArgs.success === false) {
                    throw new Error(getArgs.msg);
                }

                const cred = await navigator.credentials.get(getArgs);

                const authenticatorAttestationResponse = {
                    id: cred.rawId ? arrayBufferToBase64(cred.rawId) : null,
                    clientDataJSON: cred.response.clientDataJSON ? arrayBufferToBase64(cred.response.clientDataJSON) : null,
                    authenticatorData: cred.response.authenticatorData ? arrayBufferToBase64(cred.response.authenticatorData) : null,
                    signature: cred.response.signature ? arrayBufferToBase64(cred.response.signature) : null,
                    userHandle: cred.response.userHandle ? arrayBufferToBase64(cred.response.userHandle) : null
                };

                rep = await window.fetch('server.php?fn=processGet', {
                    method: 'POST',
                    body: JSON.stringify(authenticatorAttestationResponse),
                    cache: 'no-cache'
                });
                const authenticatorAttestationServerResponse = await rep.json();

                if (authenticatorAttestationServerResponse.success) {
                    window.alert(authenticatorAttestationServerResponse.msg || 'Login success');
                } else {
                    throw new Error(authenticatorAttestationServerResponse.msg);
                }

            } catch (err) {
                window.alert(err.message || 'Unknown error occurred');
            }
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            let bytes = new Uint8Array(buffer);
            let len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</body>
</html>
